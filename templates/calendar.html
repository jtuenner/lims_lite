<!DOCTYPE html>
<html>
<head>
    <title>{{ lab.name }} Calendar</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <style>
        :root { --bg-color: #f0f2f6; --sidebar-bg: #ffffff; --text-color: #31333F; --primary-color: #ff4b4b; --secondary-color: #262730; --card-radius: 0.5rem; }
        body { font-family: "Source Sans Pro", sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; display: flex; height: 100vh; }
        .sidebar { width: 300px; background: var(--sidebar-bg); padding: 2rem; display: flex; flex-direction: column; border-right: 1px solid #e0e0e0; flex-shrink: 0; }
        .logo { font-size: 1.5rem; font-weight: 700; color: var(--secondary-color); margin-bottom: 2rem; }
        .sidebar-link { display: flex; align-items: center; gap: 10px; padding: 12px; color: #333; text-decoration: none; border-radius: 6px; margin-bottom: 8px; font-weight: 600; transition: background 0.2s; }
        .sidebar-link:hover { background: #f0f0f0; } .sidebar-link.active { background: #ffebeb; color: var(--primary-color); }
        .sidebar-link i { width: 20px; text-align: center; }
        .context-box { margin-top: 20px; padding: 15px; background: #f9f9f9; border-radius: 6px; border: 1px solid #eee; }
        .main-content { flex: 1; padding: 2rem; overflow-y: auto; display: flex; flex-direction: column; }
        #calendar { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); flex: 1; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 2rem; border-radius: 8px; width: 450px; }
        input, select { width: 100%; padding: 10px; margin: 5px 0 15px 0; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        label { font-weight: 600; font-size: 0.9rem; color: #555; }
        .btn-primary { width: 100%; padding: 12px; background: var(--primary-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-delete { width: 100%; padding: 12px; background: white; color: red; border: 1px solid red; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        /* Search Box Styles (Same as Dashboard) */
        .search-container { position: relative; margin-bottom: 2rem; margin-top: 2rem;}
        .search-input { width: 100%; padding: 0.7rem 0.7rem 0.7rem 2.2rem; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-family: inherit; }
        .search-icon { position: absolute; left: 10px; top: 13px; color: #888; font-size: 0.9rem; }
        #searchResults { display: none; position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #ddd; border-radius: 0 0 6px 6px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); z-index: 1000; overflow: hidden; }
        .search-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; font-size: 0.9rem; transition: background 0.1s; display: flex; align-items: center; gap: 10px; text-decoration: none; color: inherit; }
        .search-item:hover { background: #f0f0f0; }
        .search-tag { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; color: white; font-weight: bold; text-transform: uppercase; min-width: 60px; text-align: center; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo"><i class="fas fa-flask"></i> LIMS Lite</div>
        <a href="/" class="sidebar-link"><i class="fas fa-th-large"></i> Dashboard</a>
        <a href="/labs" class="sidebar-link active"><i class="fas fa-calendar-alt"></i> Lab Calendars</a>
        <a href="/projects" class="sidebar-link"><i class="fas fa-folder-open"></i> Projects</a>
        <a href="/templates" class="sidebar-link"><i class="fas fa-file-alt"></i> Templates</a>
        <a href="/inventory" class="sidebar-link"><i class="fas fa-boxes"></i> Inventory</a>
        {% if user.role == 'Admin' %}
        <a href="/admin" class="sidebar-link" style="color:#d32f2f;"><i class="fas fa-user-shield"></i> Admin Panel</a>
        {% endif %}
        
        <div class="search-container">
            <form action="/search" method="get" id="searchForm"><i class="fas fa-search search-icon"></i><input type="text" name="q" id="searchInput" class="search-input" placeholder="Search..." autocomplete="off"></form>
            <div id="searchResults"></div>
        </div>

        <div class="context-box">
            <div style="font-size:0.75rem; color:#888; text-transform:uppercase; margin-bottom:5px;">Viewing Lab</div>
            <div style="font-weight:bold;">{{ lab.name }}</div>
            <a href="/labs" style="display:block; margin-top:10px; font-size:0.85rem; text-decoration:none; color:#d32f2f;">&larr; Back to all Labs</a>
        </div>
        
        <div style="margin-top:auto; padding-top:15px; border-top:1px solid #eee;">
            <div style="font-weight:bold; font-size:0.9rem;">ðŸ‘¤ {{ user.username }}</div>
            <a href="/logout" style="color:#d32f2f; text-decoration:none; font-size:0.85rem;">Sign Out</a>
        </div>
    </div>

    <div class="main-content">
        <h2 style="margin-top:0;">{{ lab.name }} Schedule</h2>
        <div id='calendar'></div>
    </div>

    <div id="bookingModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle" style="margin-top:0;">Book Slot</h3>
            <input type="hidden" id="eventId">
            
            <label>Resource</label>
            <select id="resource">
                {% for res in resources %}
                    <option value="{{ res }}">{{ res }}</option>
                {% endfor %}
            </select>
            
            {% if resources|length == 0 %}
                <div style="color:red; font-size:0.85rem; margin-top:5px; background:#fff0f0; padding:10px; border-radius:4px; border:1px solid #ffcccc;">
                    <i class="fas fa-exclamation-circle"></i> No equipment listed for this lab.<br>
                    <a href="/labs" style="color:#d32f2f; font-weight:bold;">Go to Labs</a> to add resources.
                </div>
            {% endif %}
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
                <div><label>Start Time</label><input type="datetime-local" id="start"></div>
                <div><label>End Time</label><input type="datetime-local" id="end"></div>
            </div>
            
            <input type="hidden" id="user" value="{{ user.username }}">
            
            <button class="btn-primary" onclick="saveBooking()">Confirm Booking</button>
            <button class="btn-delete" id="deleteBtn" onclick="deleteBooking()" style="display:none;">Cancel Booking</button>
            <button onclick="closeModal()" style="width:100%; padding:10px; background:none; border:none; color:#666; cursor:pointer; margin-top:5px;">Close</button>
        </div>
    </div>

    <script>
        let calendar; 
        const modal = document.getElementById('bookingModal');
        const LAB_ID = {{ lab.id }}; 

        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
                slotMinTime: "07:00:00", slotMaxTime: "22:00:00", selectable: true,
                events: `/api/bookings?lab_id=${LAB_ID}`,
                
                select: function(info) {
                    document.getElementById('modalTitle').innerText = "New Booking";
                    document.getElementById('eventId').value = ""; 
                    document.getElementById('deleteBtn').style.display = "none";
                    document.getElementById('start').value = toLocalStr(info.start);
                    document.getElementById('end').value = toLocalStr(info.end);
                    modal.style.display = "flex";
                },
                
                eventClick: function(info) {
                    document.getElementById('modalTitle').innerText = "Edit Booking";
                    document.getElementById('eventId').value = info.event.id;
                    document.getElementById('resource').value = info.event.extendedProps.resource;
                    document.getElementById('start').value = toLocalStr(info.event.start);
                    document.getElementById('end').value = toLocalStr(info.event.end);
                    document.getElementById('deleteBtn').style.display = "block";
                    modal.style.display = "flex";
                }
            });
            calendar.render();
        });

        function toLocalStr(date) {
            const offset = date.getTimezoneOffset() * 60000;
            return (new Date(date - offset)).toISOString().slice(0, 16);
        }

        function saveBooking() {
            const id = document.getElementById('eventId').value;
            const resVal = document.getElementById('resource').value;
            
            if(!resVal) { 
                alert("Please select a resource! If none are available, edit the Lab settings."); 
                return; 
            }

            const data = {
                title: "Booked", 
                resource: resVal,
                user: document.getElementById('user').value,
                start: document.getElementById('start').value,
                end: document.getElementById('end').value,
                lab_id: LAB_ID
            };
            
            if(id) {
                fetch('/api/bookings/delete', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id: parseInt(id)})
                }).then(() => createNew(data));
            } else {
                createNew(data);
            }
        }
        
        function createNew(data) {
            fetch('/api/bookings/create', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            }).then(res => res.json()).then(data => {
                if(data.status === 'success') { calendar.refetchEvents(); closeModal(); }
            });
        }

        function deleteBooking() {
            const id = document.getElementById('eventId').value;
            if(confirm("Cancel this booking?")) {
                fetch('/api/bookings/delete', {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id: parseInt(id)})
                }).then(res => res.json()).then(data => {
                    if(data.status === 'success') { calendar.refetchEvents(); closeModal(); }
                });
            }
        }

        function closeModal() { modal.style.display = 'none'; }
        window.onclick = function(e) { if(e.target == modal) closeModal(); }
        
        // Search Logic (Standard)
        const searchInput = document.getElementById('searchInput'); 
        const resultsBox = document.getElementById('searchResults'); 
        let timer;
        searchInput.addEventListener('input', e => { 
            const q = e.target.value; clearTimeout(timer); if(q.length < 2) { resultsBox.style.display='none'; return; } 
            timer = setTimeout(() => { fetch(`/api/search_autocomplete?q=${q}`).then(r => r.json()).then(d => { if(d.length > 0) { let html = ''; d.forEach(i => { html += `<a href="${i.url}" class="search-item"><div class="search-tag" style="background:${i.color}">${i.category}</div><div style="flex:1;"><div style="font-weight:600;">${i.name}</div><div style="font-size:0.8rem; color:#888;">${i.info}</div></div><i class="fas ${i.icon}" style="color:#ccc;"></i></a>`; }); html += `<div onclick="document.getElementById('searchForm').submit()" style="padding:10px; text-align:center; font-size:0.8rem; color:#666; cursor:pointer; background:#f5f5f5;">View All Results</div>`; resultsBox.innerHTML = html; resultsBox.style.display='block'; } else { resultsBox.style.display='none'; } }); }, 300); 
        });
        document.addEventListener('click', function(e) { if (!searchInput.contains(e.target) && !resultsBox.contains(e.target)) { resultsBox.style.display = 'none'; } });
    </script>
</body>
</html>